# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Is

SoftDeck is a Windows-only PyQt6 desktop app that acts as a configurable button deck (similar to Stream Deck). It presents a grid of customizable buttons that can launch apps, send hotkeys, input text macros, control media, monitor system stats, open URLs, run shell commands, and navigate between folders. Buttons are organized in an infinitely nestable folder tree structure, navigated via a toggleable left-side tree panel. It runs as a single-instance frameless always-on-top resizable window with a system tray icon and adjustable opacity. Two input modes: **Shortcut Mode** (default) — Num Lock toggles visibility (OFF = show, ON = hide) and numpad keys trigger grid buttons; **Widget Mode** — always-visible mouse-only widget with no numpad/NumLock integration. Mode is switchable live via Settings without restart.

## Running

**With embedded Python (no install required):** Double-click `SoftDeck.bat`. On first run, it auto-downloads Python 3.13.2 embedded distribution + pip + dependencies into `python/` folder, then launches the app. Subsequent runs skip setup and launch immediately.

**With system Python:** `python main.py`

Dependencies: `pip install -r requirements.txt` (requires Windows — uses pywin32, pycaw, comtypes, keyboard, winrt-Windows.Media.Control, pynput).

**Embedded Python setup details:** `SoftDeck.bat` checks for `python/pythonw.exe`. If missing, it downloads `python-3.13.2-embed-amd64.zip` from python.org, extracts to `python/`, enables `import site` in `python313._pth`, adds `..` (project root) to the path file, installs pip via `get-pip.py`, and runs `pip install -r requirements.txt`. The `python/` folder is gitignored.

## Architecture

**Entry flow:** `main.py` checks single-instance via Win32 Named Mutex (`CreateMutexW`) **before any imports**, then → `src/app.py:SoftDeckApp` (subclasses QApplication). This prevents a second instance from importing `keyboard` or creating a QApplication, which could interfere with the first instance's Win32 keyboard hooks.

**Initialization order in `SoftDeckApp.__init__`:**
1. Logging setup (file log to `%APPDATA%/SoftDeck/app.log` + console if stdout exists)
2. Single-instance check (`_ensure_single_instance` — kills existing `softdeck.exe` via psutil if mutex already held, retries up to 5s)
3. `ConfigManager` load
4. Theme resolution (`get_theme(settings.theme)` → `ThemeStylesheets`)
5. `ToastManager` creation (themed toast notifications)
6. `ActionRegistry` + built-in action registration
7. `PluginLoader` discover + load → plugin actions registered into `ActionRegistry`
8. `InputDetector` start (only in shortcut mode; skipped in widget mode)
9. `MainWindow` construction + service injection (`set_input_detector`, `set_toast_manager`)
10. `TrayIcon` construction
11. Background services start (`SystemStatsService`, optionally `ActiveWindowMonitor`, optionally `MediaPlaybackMonitor` from media plugin, mute state `QTimer` polling via `MediaControlService`)
12. Theme applied globally via `setStyleSheet`
13. Window shown: widget mode → always show; shortcut mode → only if Num Lock is OFF (Num Lock ON → start hidden)
14. Ready notification (themed toast + system sound)

**Seven main subsystems:**

1. **Config** (`src/config/`) — Dataclass-based models (`AppConfig` v2 → `AppSettings` + `FolderConfig` (recursive tree) → `ButtonConfig[]` → `ActionConfig`). `FolderConfig` supports infinite nesting via `children: list[FolderConfig]`. `FolderConfig.expanded` (bool, default `True`) tracks tree expand/collapse state. `ButtonConfig` includes per-button styling: `label_color` (hex string, default empty = white), `label_size` (int px, default 0 = use `AppSettings.default_label_size`). `ConfigManager` handles load/save with atomic writes (tmp file + `shutil.move`), plus `export_config(path)`/`import_config(path)` for whole-config JSON export/import and `export_folder(folder_id, path)`/`import_folder(parent_id, path)` for per-folder export/import (envelope format: `{"type": "softdeck_folder", "app_version": ..., "folder": ...}`). **Icon embedding:** export methods collect icon files referenced in `ButtonConfig.icon` and `ActionConfig.params` toggle icon keys (`_ICON_PARAM_KEYS`: `play_icon`, `pause_icon`, `mute_icon`, `unmute_icon`, `mic_on_icon`, `mic_off_icon`) as base64 into `"_icons": {basename: b64str}` — any existing file is included regardless of its location on disk. Import methods restore icons to `%APPDATA%/SoftDeck/icons/` and rewrite all paths to the local directory (skips write if file already exists; backward-compatible — missing `_icons` key is treated as empty). `_regenerate_folder_ids(folder_dict)` (staticmethod) assigns fresh IDs to all folders in a dict and remaps internal `navigate_folder`/`navigate_page` button references; used by `import_folder` to avoid ID collisions on repeated imports. User config lives at `%APPDATA%/SoftDeck/config.json`, falling back to `config/default_config.json`. Automatic v1→v2 migration converts flat `pages` list to `root_folder` tree. `AppSettings` fields: `grid_rows` (default 4), `grid_cols` (default 5), `button_size` (default 60px), `button_spacing` (default 8px), `default_label_size` (default 10px), `default_label_family` (font family, default empty), `input_mode` (`"shortcut"` or `"widget"`, default `"shortcut"`), `auto_switch_enabled` (default `True`), `always_on_top` (default `True`), `theme` (default `"dark"`), `window_opacity` (0.2–1.0, default 0.9), `folder_tree_visible` (default `True`), `window_x`/`window_y` (last position, `None` = center-top). `AppConfig` stores `app_version` from `src/version.py` (`APP_VERSION = "0.1.1"`); on load, version mismatch triggers re-save. `ConfigManager.load()` also migrates `grid_rows < 4` → 4 (added numpad 0/. row). **Example folder injection:** `_inject_example_folders(old_app_version)` scans `config/examples/*.json` on first run or version upgrade. Each JSON has `{"version": "...", "name_suffix": "...", "folder": {...}}`. `_version_tuple()` parses versions for comparison (`""` < `"0.1.0-beta"` < `"0.1.0"` < `"0.1.1"` — pre-release sorts lower than release). Injects when example's version > old_app_version; folder name is `{version}_{name_suffix}` (e.g., `0.1.1_Media`); skips if same name already exists in root_folder.children; uses `_regenerate_folder_ids()` for fresh IDs. First run passes `""` → all examples injected; existing config passes stored `app_version` → only newer examples injected.

2. **Actions** (`src/actions/`) — `ActionBase` is the ABC with `execute(params)` and `get_display_text(params)`. `ActionRegistry` maps string type names to action instances and holds an optional `main_window` reference for `NavigateFolderAction`. Built-in types: `launch_app`, `hotkey`, `text_input`, `system_monitor`, `navigate_folder` (+ `navigate_page` alias for backward compat), `navigate_parent`, `navigate_back`, `open_url`, `open_folder`, `macro`, `run_command`. `NavigateParentAction` calls `MainWindow.navigate_parent()` (goes to parent folder, no params). `NavigateBackAction` calls `MainWindow.navigate_back()` (pops from folder history stack, falls back to parent if history empty, no params). Plugin-provided types: `media_control` (via media_control plugin). `LaunchAppAction` uses `MainWindow.launch_with_foreground()` wrapper around `os.startfile()` (ensures launched app window gets foreground) with `subprocess.Popen(CREATE_NEW_CONSOLE)` fallback when arguments are provided. `HotkeyAction` has `_SPECIAL_HOTKEYS` dict (lazily initialized via `_init_special()`) for Windows-protected shortcuts (e.g., `win+l` → `LockWorkStation()` API). `TextInputAction` supports `use_clipboard` mode — when True, copies text to clipboard via `win32clipboard` and pastes with `Ctrl+V` instead of using `keyboard.write()`. `OpenUrlAction` uses `os.startfile()` (Windows shell default browser). `OpenFolderAction` uses `os.startfile()` to open a specified folder in Windows Explorer; supports environment variables (`%USERPROFILE%`) and `~` via `os.path.expandvars()`/`os.path.expanduser()`; validates path is a directory before opening. `MacroAction` supports 8 step types: `hotkey` (keyboard.send), `text_input` (keyboard.write or clipboard paste), `delay` (time.sleep), `key_down`/`key_up` (pynput keyboard.Controller press/release), `mouse_down`/`mouse_up` (pynput mouse.Controller position + press/release), `mouse_scroll` (pynput mouse.Controller position + scroll). Module-level helpers `_resolve_pynput_key(key_name, vk)` and `_resolve_mouse_button(name)` convert recorded params to pynput objects; pynput is lazy-imported inside each method. To add a new action: create a plugin (see Plugins subsystem) or subclass `ActionBase` and register in `SoftDeckApp._register_actions()`.

3. **Services** (`src/services/`) — Background workers:
   - `SystemStatsService(QThread)` — polls CPU/RAM via psutil, emits `stats_updated(float, float)`
   - `ActiveWindowMonitor(QThread)` — polls foreground window via win32gui/win32process, emits `active_app_changed(str)` to drive auto-folder-switching
   - `MacroRecorder` — records keyboard & mouse events via pynput listeners. `_RecorderSignals(QObject)` emits `event_recorded(int)`, `recording_stopped(list)`, `recording_cancelled()`. `start()` creates pynput keyboard/mouse Listeners (lazy import); `stop()` returns recorded steps; `cancel()` discards. Events: `key_down`/`key_up` (key name + vk code), `mouse_down`/`mouse_up` (button + x,y), `mouse_scroll` (x,y,dx,dy). Auto-inserts `delay` steps between events via `time.perf_counter()` (5ms minimum threshold). F9 stops recording, Escape cancels (both excluded from recorded events). pynput callbacks run in background threads → `QTimer.singleShot(0, ...)` bridges to main thread for stop/cancel.
   - `InputDetector` — launches `numpad_hook.dll` in a separate `rundll32.exe` process and communicates via named shared memory (`Local\SoftDeck_NumpadHook`). Polls events from a lock-free ring buffer via `QTimer` at 16ms (~60Hz). Detects Num Lock toggles and emits `numpad_signal.numlock_changed(bool)` to drive window visibility (Num Lock ON → hide, OFF → show). Numpad scan codes 71–73/75–77/79–83 map to grid positions `(row, col)` in a 4-row layout matching the physical numpad: 7-8-9 → row 0, 4-5-6 → row 1, 1-2-3 → row 2, 0 → (3,0), . → (3,2). All numpad keys emit `numpad_signal.pressed(row, col)`; there is no separate `back_pressed` signal — navigate-parent is a regular button action at (3,0). Static method `is_numlock_on()` checks current state at startup. `is_running` property returns `True` when the hook process is active (used by `apply_input_mode()`). Has `_passthrough` flag toggled via `set_passthrough(bool)` — when True, numpad keys pass through (used when dialogs are open). Passes `os.getpid()` to rundll32 so the DLL auto-exits if the parent process crashes. In widget mode, `InputDetector` is never started (no hook process, no numpad capture).

4. **UI** (`src/ui/`) — Frameless `MainWindow` with custom `TitleBar` (defined in `main_window.py`, provides drag support + folder tree toggle button + current folder name label (centered) + opacity slider + tray button + right-click context menu with Settings / Export Config / Import Config). TitleBar height is 25px with top-aligned layout; folder name is updated via `TitleBar.update_folder_name()` whenever `_load_current_folder()` runs. Window supports 8-direction edge drag resize (`_Edge` IntFlag + `_EDGE_CURSORS` mapping, 6px margin detection). Layout: `QVBoxLayout(TitleBar + QSplitter(FolderTreeWidget | GridContainer) + VersionLabel)`. `FolderTreeWidget` (in `folder_tree.py`) is a `QTreeWidget` showing the recursive folder structure with drag-and-drop reordering and right-click context menu (New Sub-Folder / Rename / Edit / Export Folder / Import Folder / Move Up / Move Down / Delete). Compact layout: `setIndentation(12)` (reduced from default ~20px for deep nesting), `minWidth=120`/`maxWidth=300`, item padding `3px 4px 3px 2px`. Splitter initial tree width is 140px. `QGridLayout` of `DeckButton` widgets. **Grid layout:** `MainWindow._COLSPAN` dict defines column-spanning buttons (physical numpad layout: `(3,0)` spans 2 columns for Numpad 0); `_HIDDEN` frozenset lists cells covered by spans (`(3,1)`). Buttons at spanned positions get `width_override = size * colspan + spacing * (colspan - 1)`. Non-root folders auto-fill `(3,0)` with a `navigate_parent` button if empty. All folders (including root) auto-fill `(3,2)` with a `navigate_back` button if empty. Both auto-filled buttons are icon-only (no label). `DeckButton` overrides `paintEvent` when an icon is set or marquee scroll is active: draws button background → icon (full opacity, centered) → label text on top, applying per-button `label_color` and `label_size`. **Marquee scroll:** when any text line exceeds the button's available width (button width minus 12px padding), `DeckButton` auto-scrolls the text horizontally. Triggered via `setText()` override → `_check_scroll_needed()` (resolves display font via per-button `label_size` / settings default, measures each line via `QFontMetrics.horizontalAdvance()`). Animation runs on a `QTimer` (33ms, ~30fps) cycling through 3 phases: PAUSE_START (~1.5s at start position) → SCROLL (~30px/s leftward) → PAUSE_END (~1s at end position) → loop. `_scroll_active` flag routes `paintEvent` to custom paint path with `setClipRect` (6px side padding) and offset `drawText`. Text change resets scroll to start. `reconfigure()` calls `_stop_scroll()` to clean up. Primary targets: `now_playing` (artist/title), `audio_device_switch` (device name), any button with long labels. If a button has an icon and its label is empty, text is hidden (icon-only display). **Icon priority:** per-state toggle icon (`ActionConfig.params` `play_icon`/`pause_icon`/`mute_icon`/`unmute_icon`) > per-button custom icon (`ButtonConfig.icon`) > default action icon (`assets/icons/actions/`) > plugin icon (`PluginBase.get_icon_path()`) > no icon (text only). **Media toggle buttons** (`play_pause`, `mute`) support per-state icons and labels stored in `ActionConfig.params`; when a per-state label is set without a per-state icon, default icons are suppressed for text-only display. `DeckButton` tracks `_media_is_playing` and `_media_is_muted` flags; shared update logic in `_update_media_toggle()` via `_MEDIA_TOGGLE_KEYS` dict maps each toggle command to its active/inactive param key pairs. Default icons resolved by `default_icons.py`: built-in action types map to `assets/icons/actions/{type}.png`; plugin icons fall through to `_plugin_icon_resolver` callback set by `set_plugin_icon_resolver()`. Supports `.png`/`.svg`/`.ico` extensions. **SVG rendering:** `_load_pixmap(path)` helper in `button_widget.py` renders SVG files via `QSvgRenderer` at 128×128 (crisp at any button size); non-SVG files use `QPixmap` directly. Custom `paintEvent` enables `TextAntialiasing` render hint for sharp text over icons. Font size priority: per-button `label_size` > 0 → use that value; otherwise → `AppSettings.default_label_size`. **Button label priority:** in `_update_display()`, user-defined label (`ButtonConfig.label`) takes priority over `get_display_text()` fallback; `get_display_text()` only shows when label is empty (e.g., macro shows "Macro (N steps)" only if no custom label set). Buttons are right-click editable via `ButtonEditorDialog` (uses `QStackedWidget` per action type; includes `HotkeyRecorderWidget` for keyboard capture with `grabKeyboard()`, color picker for label color, font size spin box). **Macro editor** has a step list (`QListWidget`, min height 120px) with Add/Delete/Move/Record buttons. 8 step types supported: `hotkey`, `text_input`, `delay`, `key_down`, `key_up`, `mouse_down`, `mouse_up`, `mouse_scroll`. The "Record" button launches `MacroRecorder` + `MacroRecordingDialog` (floating `Tool|WindowStaysOnTopHint|FramelessWindowHint` overlay showing event count, elapsed time, Stop/Cancel buttons); recorded steps are appended to the step list. Step editor widgets: hotkey (HotkeyRecorderWidget), text_input (QTextEdit + clipboard checkbox), delay (QSpinBox ms), key_down/key_up (readonly key name + vk QSpinBox), mouse_down/mouse_up (button QComboBox + x,y QSpinBox), mouse_scroll (x,y,dx,dy QSpinBox). **Plugin type selection** is two-level: the main Type combo has a "Plugin" (`_plugin`) meta-entry; selecting it shows a Plugin page with a secondary `_plugin_combo` listing all loaded plugins, plus a nested `_plugin_editor_stack` showing the selected plugin's editor widget. On save, `_plugin` is resolved to the actual plugin action type (e.g., `media_control`); on load, plugin action types are detected and mapped back to "Plugin" + the correct sub-selection. Config format is unchanged (stores the real action type, not `_plugin`); Launch App page has "Browse..." (file picker, defaults to All Files filter, auto-fills Path + Working Dir + Icon on selection via `_save_app_icon()`) and "Find App..." (`AppFinderDialog` — two-tab dialog scanning running processes via psutil and Start Menu .lnk shortcuts via WScript.Shell COM, displays exe icons via `QFileIconProvider`, saves selected icon as PNG to `%APPDATA%/SoftDeck/icons/` and auto-fills Path + Working Dir + Icon fields). **Icon transparent padding crop:** `_crop_transparent_padding()` in `app_finder_dialog.py` detects when extracted icon content fills less than 50% of the canvas (common with some exe icons where a small image sits in a large transparent 256×256 canvas) and crops to the content bounding box with small padding; used by both `AppFinderDialog._save_icon()` and `ButtonEditorDialog._save_app_icon()`. Button context menu also supports Copy/Paste to duplicate button configs across positions. **Button drag-and-drop swap:** `DeckButton` supports left-click drag to swap positions with another button. Uses custom MIME type `application/x-deckbutton-pos` carrying `(row,col)`. Drag threshold is `QApplication.startDragDistance()`; empty buttons cannot be dragged but can receive drops. Drop on occupied cell swaps both `ButtonConfig.position` values; drop on empty cell moves the source button. Visual feedback: accent border on drag-over target, semi-transparent `grab()` pixmap as drag image. All dialog `.exec()` calls are wrapped with `set_numpad_passthrough(True/False)` to allow numpad input while editing. Folders managed via `FolderEditorDialog` (includes "Find App..." button that opens `AppFinderDialog` to select running processes/Start Menu apps, adds exe filename to mapped apps list). Settings via `SettingsDialog` (button size/spacing/default font/default font size, behavior (input mode selector/auto-switch/always-on-top), appearance (theme selector/opacity) — grid rows/cols hidden from UI). `TrayIcon` provides show/settings/reset position/quit context menu and double-click to show. **Toast notifications** (`toast.py`): custom themed `_ToastWidget` (frameless `ToolTip` window with `WA_TranslucentBackground` + `WA_ShowWithoutActivating`) managed by `ToastManager`. Each toast has a themed background (`bg_elevated`), accent-colored left bar (type-specific: INFO=theme accent, SUCCESS=green, WARNING=amber, ERROR=red), progress bar at bottom that shrinks over the duration. Animation: slide-up + fade-in (300ms OutCubic), auto-dismiss with fade-out (250ms InCubic). Click to dismiss early. Multiple toasts stack upward from bottom-right of primary screen (above taskbar). `ToastManager.set_palette()` syncs with theme changes via `MainWindow.apply_theme()`. **Window focus management:** `MainWindow.showEvent()` reinforces `WS_EX_NOACTIVATE` to prevent click-through focus stealing. `launch_with_foreground(callback)` temporarily claims foreground, executes the launch callback, then schedules a fallback timer (800ms) to bring the new app window to front via the `SetWindowPos` TOPMOST/NOTOPMOST trick. **Auto-focus mapped app:** `focus_mapped_app() -> bool` checks the current folder's `mapped_apps` and focuses the mapped app's window before `hotkey`/`text_input`/`macro` actions execute, so keystrokes reach the correct target app. Returns `False` (no delay) if: no mapping, foreground is already the mapped app, or app not running. Returns `True` after focusing (caller delays 100ms via `QTimer.singleShot`). Uses `_find_mapped_app_window(target_set)` (`EnumWindows` + `win32process` + `psutil`, filters `WS_EX_TOOLWINDOW`) and `_focus_existing_window(target_hwnd)` (same `WS_EX_NOACTIVATE` removal + `AttachThreadInput` + `TOPMOST/NOTOPMOST` pattern as `launch_with_foreground`, plus `IsIconic` → `ShowWindow(SW_RESTORE)` for minimized windows). `DeckButton._on_clicked()` dispatches via three action categories: `_FOREGROUND_ACTIONS` (launch_app/open_url/open_folder/run_command → `launch_with_foreground`), `_TARGET_FOCUS_ACTIONS` (hotkey/text_input/macro → `focus_mapped_app` + delayed execute), all others → immediate execute. Version label (`v{APP_VERSION}`) shown bottom-right with minimal opacity.

5. **Styles** (`src/ui/styles.py`) — Multi-theme system with semantic color palettes. `ThemePalette` (frozen dataclass) defines ~25 semantic colors (background hierarchy, borders, text levels, accent, splash, etc.). `ThemeStylesheets` (frozen dataclass) holds pre-generated stylesheets for a palette. `get_theme(name)` resolves and caches a `ThemeStylesheets` instance. 10 built-in themes: `dark` (default), `light`, `solarized_light`, `midnight`, `emerald`, `violet`, `nord`, `dracula`, `amber`, `cyber`. Backward-compat module-level constants (`DARK_THEME`, `DECK_BUTTON_STYLE`, etc.) resolve to the `dark` theme. `MainWindow.apply_theme(name)` switches themes at runtime — updates QApplication global stylesheet, title bar, folder tree, version label, toast manager palette, and button styles.

6. **Native Hook** (`src/native/`) — C DLL (`numpad_hook.dll`) that implements `WH_KEYBOARD_LL` keyboard hook in a separate process for reliable key suppression.

   **Why a separate process?** Two constraints forced this architecture:
   - **PyInstaller exe cannot suppress keyboard hooks.** When `WH_KEYBOARD_LL` hook callback returns 1 (suppress) from a PyInstaller-bundled exe, Windows ignores the suppression — the hook fires and sees the key, but the key still reaches the target app (e.g. VSCode). The same code works perfectly from `python.exe` (signed/trusted). This appears to be a Windows security/trust issue with unsigned executables.
   - **Corporate security software deletes new `.exe` files** compiled with MinGW/gcc, but leaves `.dll` files alone.

   **Solution:** `rundll32.exe` (trusted Windows system binary) hosts the DLL. Python launches `rundll32.exe "path\numpad_hook.dll",start_entry <parent_pid>`. The DLL's `start_entry` function starts the hook thread, creates shared memory, and blocks until either Python sets `running=0` or the parent process (identified by PID) dies.

   **Architecture:**
   - `numpad_hook.dll` — hook callback (`hook_proc`) + shared memory IPC + `start_entry` for rundll32
   - `SharedData` struct (packed, matches Python `_SharedData` in `input_detector.py`): lock-free ring buffer (`ev_write`/`ev_read`/`events[256]`), Num Lock state (`nl_changed`/`nl_new_state`/`numlock_off`), control flags (`passthrough`/`running`), debug counters (`any_key_count`/`suppressed`/`numpad_seen`/`hook_ok`)
   - Shared memory name: `Local\SoftDeck_NumpadHook`
   - Hook suppresses numpad nav keys (scan 71–73, 75–77, 79–83) when `numlock_off=1` and `passthrough=0`, writing scan codes to the ring buffer
   - The hook thread uses `SetTimer` (200ms) to check the `running` flag and `PostQuitMessage` when it's 0
   - Compile: `gcc -shared -O2 -o numpad_hook.dll numpad_hook.c -luser32 -lkernel32` (requires MSYS2 MinGW64, `PATH` must include `/c/msys64/mingw64/bin:/c/msys64/usr/bin`)

7. **Plugins** (`src/plugins/`) — Auto-discovered plugin system for extending action types. `PluginBase` (ABC in `base.py`) defines the plugin interface: `get_action_type()`, `get_display_name()`, `create_action()` (required); `create_editor()`, `get_icon_path(params)`, `initialize()`, `shutdown()` (optional). `PluginEditorWidget` (ABC) defines custom editor UI: `create_widget(parent)`, `load_params(params)`, `get_params()`. `PluginLoader` (`loader.py`) scans `src/plugins/*/` sub-packages via `pkgutil.iter_modules()`, imports each, and looks for a `Plugin` class. Plugin actions are registered into `ActionRegistry` alongside built-in actions (indistinguishable at dispatch time). Plugin editors are shown in `ButtonEditorDialog` via two-level selection: Type → "Plugin" → plugin sub-selector (`_plugin_combo`) → nested `_plugin_editor_stack`. Plugin icon paths fall through the icon resolver chain: per-button icon > built-in `ACTION_ICON_MAP` > plugin `get_icon_path()`. To add a new plugin: create `src/plugins/my_feature/` with `__init__.py` (exports `Plugin = MyFeaturePlugin`), `plugin.py` (subclasses `PluginBase`), `action.py` (subclasses `ActionBase`), optionally `editor.py` (subclasses `PluginEditorWidget`).

   **Current plugin — `media_control`** (`src/plugins/media_control/`):
   - `MediaControlPlugin` — registers action type `"media_control"`, provides `MediaControlAction` + `MediaControlEditorWidget` + `MediaControlService` + `MediaPlaybackMonitor`. Tracks `_is_playing`, `_is_muted`, and `_is_mic_muted` state flags for dynamic icon resolution. `get_service()` exposes the `MediaControlService` for mute polling.
   - `MediaControlAction` — 10 commands: `play_pause`/`next_track`/`prev_track`/`stop` (via `keyboard.send()` media keys), `volume_up`/`volume_down`/`mute`/`mic_mute` (via pycaw `IAudioEndpointVolume`), `now_playing` (display-only, click sends play/pause), `audio_device_switch` (cycles output device via pycaw)
   - `MediaControlService` — wraps pycaw `AudioUtilities.GetSpeakers().EndpointVolume` for volume get/set/mute + microphone mute. `is_muted()`/`is_mic_muted()` return current mute states (polled from main thread via `QTimer` in `SoftDeckApp`). `cycle_audio_output_device()` switches to the next audio output device. `get_current_audio_output_name()` returns the current device's friendly name.
   - `MediaPlaybackMonitor(QThread)` — polls Windows SMTC (System Media Transport Controls) via WinRT `GlobalSystemMediaTransportControlsSessionManager` every 1s, emits `playback_state_changed(bool)`. Gracefully degrades if WinRT unavailable (`available=False`). Used for dynamic play/pause button icon (shows play or pause icon based on playback state)
   - `MediaControlEditorWidget` — `QComboBox` command selector (10 commands) + per-state toggle settings. `_TOGGLE_COMMANDS` dict defines which commands (`play_pause`, `mute`, `mic_mute`) get per-state icon/label UI groups. For `play_pause`: Play Icon/Label + Pause Icon/Label; for `mute`: Mute Icon/Label + Unmute Icon/Label; for `mic_mute`: Mic On Icon/Label + Mic Off Icon/Label. Groups show/hide based on selected command. Param keys: `play_icon`/`play_label`/`pause_icon`/`pause_label` (play_pause), `mute_icon`/`mute_label`/`unmute_icon`/`unmute_label` (mute), `mic_on_icon`/`mic_on_label`/`mic_off_icon`/`mic_off_label` (mic_mute). Empty values are omitted from saved params.
   - Icons at `assets/icons/actions/media_control/`, dynamic: `play_pause` resolves to `play.svg` or `pause.svg` based on `_is_playing` flag; `mute` resolves to `muted.{ext}` or `unmuted.{ext}` based on `_is_muted` flag (falls back to static `mute.{ext}` if state-specific files missing); `mic_mute` resolves to `mic_off.{ext}` or `mic_on.{ext}` based on `_is_mic_muted` flag. Static icons: `now_playing.svg`, `audio_device_switch.svg`, `next_track.svg`, `prev_track.svg`, `stop.svg`, `volume_up.svg`, `volume_down.svg`
   - **Mute state polling:** `SoftDeckApp` creates `QTimer`s (500ms) that poll `MediaControlService.is_muted()` and `is_mic_muted()` in the main thread (avoids COM threading issues with pycaw). On state change: updates `plugin._is_muted`/`_is_mic_muted` + calls `MainWindow.update_mute_state()`/`update_mic_mute_state()`. `MainWindow` caches `_last_media_muted`/`_last_mic_muted` and re-applies to buttons on folder reload. Audio device name is also polled and propagated via `update_device_name()`.

**Key data flow:** Config defines a root folder tree → each folder has `buttons` and `children` (sub-folders) → the grid shows the current folder's buttons → each button has an `ActionConfig(type, params)` → on click, `ActionRegistry.execute(type, params)` dispatches to the matching `ActionBase` subclass (built-in or plugin-provided) → services feed live data back to the UI via Qt signals. The folder tree panel allows navigation between folders; clicking a folder loads its buttons into the grid. Buttons can be copied/pasted via `DeckButton._clipboard` (class-level dict storing `ButtonConfig.to_dict()` data) or rearranged via drag-and-drop swap; `ActionConfig.params` uses `copy.deepcopy` in `to_dict()`/`from_dict()` to ensure pasted buttons are fully independent from originals.

**Keyboard shortcuts:** Global numpad keys (Num Lock OFF, via `InputDetector` hook) map to grid positions `(row, col)` matching physical numpad layout: 7-8-9 → row 0, 4-5-6 → row 1, 1-2-3 → row 2, 0 → (3,0), . → (3,2). Row 3 col 0 is a wide button (colspan=2) mirroring the physical Numpad 0 key; col 1 is hidden (covered by span); col 2 is normal width (Numpad .). All keys trigger the button at their mapped position — `navigate_parent` (go to parent folder) is the default action at (3,0) for non-root folders; `navigate_back` (history back) is the default action at (3,2) for all folders.

**Window behavior:** `closeEvent` minimizes to tray instead of quitting. `toggle_visibility` hides to tray or `show_on_primary()` (restores to last saved position, or centers on primary screen top edge if none saved). Window position is persisted to `AppSettings.window_x`/`window_y` on every move via `moveEvent`. `reset_position()` clears saved position and centers on primary screen (accessible via tray menu "Reset Position"). Window uses `setMinimumSize` (not `setFixedSize`) to allow drag resize. `set_opacity(value)` applies opacity and persists to config. TitleBar has a horizontal `QSlider` (20–100%) for real-time opacity control. **Num Lock–driven visibility (shortcut mode only):** Num Lock ON hides the window, Num Lock OFF shows it. This is checked both at startup and on every Num Lock toggle via `InputDetector`. `_on_numlock_changed` has an early return guard for widget mode. On Num Lock OFF, it re-verifies actual Num Lock state via `is_numlock_on()` before showing, then calls `_sync_folder_to_foreground()` to immediately check the current foreground app and switch to its mapped folder (bypasses `ActiveWindowMonitor`'s change-only detection). **Input mode switching:** `SoftDeckApp.apply_input_mode()` handles live switching between shortcut and widget modes — stops/starts `InputDetector` and adjusts window visibility. Called from `MainWindow.reload_config()` via `hasattr` guard after settings are applied.

**Folder navigation history:** `MainWindow._folder_history` (list of folder IDs, max 50) tracks visited folders. `switch_to_folder_id()` pushes the current folder onto the stack before switching (skipped for same-folder and when `_navigating_back` flag is set). Two separate navigation methods: `navigate_parent()` goes to the parent folder (no history interaction), `navigate_back()` pops from history (skips deleted folders via recursion, falls back to parent if history empty). The `_navigating_back` flag prevents `switch_to_folder_id()` from pushing during back navigation. All folder switches (button click, tree selection, auto-switch) go through `switch_to_folder_id()` and build history.

**Folder tree drag-and-drop:** `FolderTreeWidget.dropEvent` handles moves entirely through `ConfigManager.move_folder()` + `rebuild()`. The event is accepted with `IgnoreAction` drop action to prevent Qt's `InternalMove` mode from deleting the source row after our rebuild. **Folder reordering:** context menu "Move Up" / "Move Down" items reorder siblings within the same parent via `ConfigManager.move_folder(folder_id, parent_id, position)`. First/last child disables the corresponding action. Root folder excluded.

## Windows API Usage

The app relies heavily on Windows-specific APIs:

- **ctypes.windll.kernel32** — `CreateMutexW`/`GetLastError`/`CloseHandle` (single-instance mutex in `main.py` + `app.py`), `OpenFileMappingW`/`MapViewOfFile`/`UnmapViewOfFile` (shared memory IPC in `input_detector.py`), `GetCurrentThreadId`/`AttachThreadInput` (foreground window manipulation in `main_window.py`)
- **ctypes.windll.user32** — `GetKeyState(VK_NUMLOCK)` (Num Lock detection in `input_detector.py`), `SetWindowPos`/`SetForegroundWindow`/`GetForegroundWindow`/`EnumWindows`/`GetWindowLongW`/`SetWindowLongW`/`IsWindowVisible`/`IsIconic`/`ShowWindow`/`GetWindowThreadProcessId` (window management in `main_window.py`), `LockWorkStation` (Win+L special hotkey in `hotkey.py`)
- **pywin32** — `win32gui.GetForegroundWindow`/`win32process.GetWindowThreadProcessId` (foreground app detection in `app.py` + `window_monitor.py`), `win32clipboard` (clipboard paste mode in `text_input.py` + `macro.py`), `win32com.client.Dispatch("WScript.Shell")` (Start Menu .lnk shortcut parsing in `app_finder_dialog.py`)
- **pycaw** — `AudioUtilities.GetSpeakers().EndpointVolume` (volume get/set/mute in `plugins/media_control/service.py`)
- **WinRT** — `winrt.windows.media.control.GlobalSystemMediaTransportControlsSessionManager` (SMTC playback state detection in `plugins/media_control/playback_monitor.py`; optional — gracefully degrades if unavailable)
- **pynput** — `pynput.keyboard.Listener`/`pynput.mouse.Listener` (macro recording in `macro_recorder.py`), `pynput.keyboard.Controller.press()`/`release()` (key_down/key_up playback in `macro.py`), `pynput.mouse.Controller.press()`/`release()`/`scroll()` (mouse playback in `macro.py`); all lazy-imported
- **keyboard** — `keyboard.send()` (hotkeys + media keys), `keyboard.write()` (text input); monkey-patched in `app.py` to prevent `WH_KEYBOARD_LL` hook installation (`_kb._listener.start_if_necessary = lambda: None`)
- **Native DLL** — `numpad_hook.dll` loaded via `rundll32.exe`: `SetWindowsHookExW(WH_KEYBOARD_LL)`, `CreateFileMappingW` (shared memory), `SetTimer`/`PostQuitMessage` (lifecycle), `InterlockedIncrement`/`InterlockedExchange` (lock-free ring buffer)
- **Other** — `os.startfile()` (app/URL/folder launching), `subprocess.Popen` with `CREATE_NEW_CONSOLE`/`CREATE_NO_WINDOW` flags, `winsound.PlaySound` (ready sound), `psutil` (process enumeration + CPU/RAM stats)

## Conventions

- All modules use `from __future__ import annotations` and `TYPE_CHECKING` guards for type-only imports
- Private attributes prefixed with `_`; no public setters except through property accessors
- Qt signals/slots for all cross-component communication
- Button positions are `(row, col)` tuples
- Config uses `to_dict()`/`from_dict()` pattern (no Pydantic)
- Dialogs use lazy imports to avoid circular dependencies
- Services are injected via setter methods (e.g., `set_main_window()`, `set_media_service()`, `set_input_detector()`, `set_toast_manager()`)
- New folder IDs use `uuid.uuid4().hex[:8]`
- Config version is 2; v1 configs are auto-migrated on load
- App version tracked in `src/version.py` (`APP_VERSION`), persisted in config for migration detection and example folder injection
- Plugins export `Plugin = MyPlugin` in `__init__.py`; loader discovers via `pkgutil.iter_modules()`

## File Map

```
SoftDeck.bat                     # All-in-one launcher — auto-setup embedded Python on first run, then launch app via pythonw.exe
main.py                          # Entry point — Win32 Named Mutex single-instance check before any imports
src/version.py                   # APP_VERSION constant ("0.1.1")
src/app.py                       # SoftDeckApp — orchestrates everything (keyboard listener monkey-patched to prevent hook conflicts), apply_input_mode() for live shortcut↔widget switching
src/config/models.py             # Dataclasses: AppConfig, AppSettings, FolderConfig, ButtonConfig, ActionConfig (+ deprecated PageConfig for migration)
src/config/manager.py            # ConfigManager — load/save with atomic writes + folder CRUD + whole-config export/import + per-folder export/import (with ID regeneration) + icon embedding (base64 collect/restore) + example folder injection (_inject_example_folders + _version_tuple)
src/actions/base.py              # ActionBase ABC
src/actions/registry.py          # ActionRegistry — type→action dispatch + main_window ref
src/actions/launch_app.py        # LaunchAppAction — launch_with_foreground wrapper / subprocess.Popen(CREATE_NEW_CONSOLE) with args
src/actions/hotkey.py            # HotkeyAction — keyboard.send() + _SPECIAL_HOTKEYS (win+l → LockWorkStation, lazily initialized)
src/actions/text_input.py        # TextInputAction — keyboard.write() or clipboard paste (win32clipboard + Ctrl+V) via use_clipboard param
src/actions/navigate.py          # NavigateFolderAction + NavigateParentAction + NavigateBackAction — folder switching / parent folder / history back via registry.main_window
src/actions/system_monitor.py    # SystemMonitorAction — display-only, live data via DeckButton
src/actions/open_url.py          # OpenUrlAction — os.startfile() (Windows shell default browser)
src/actions/open_folder.py       # OpenFolderAction — os.startfile() to open folder in Explorer (supports env vars + ~ expansion)
src/actions/macro.py             # MacroAction — sequential execution of 8 step types (hotkey/text/delay + key_down/up + mouse_down/up/scroll via pynput)
src/actions/run_command.py       # RunCommandAction — shell command execution via subprocess
src/plugins/base.py              # PluginBase ABC + PluginEditorWidget ABC
src/plugins/loader.py            # PluginLoader — auto-discovery via pkgutil, lifecycle management, editor/icon delegation
src/plugins/media_control/       # Media Control plugin:
  __init__.py                    #   Exports Plugin = MediaControlPlugin
  plugin.py                      #   MediaControlPlugin — factory + lifecycle + dynamic icon resolution
  action.py                      #   MediaControlAction — 10 commands (media keys via keyboard, volume/mute/mic/device via pycaw)
  editor.py                      #   MediaControlEditorWidget — QComboBox command selector + per-state toggle icon/label editor (play_pause, mute)
  service.py                     #   MediaControlService — pycaw IAudioEndpointVolume wrapper
  playback_monitor.py            #   MediaPlaybackMonitor(QThread) — WinRT SMTC polling for play/pause state
src/services/system_stats.py     # SystemStatsService(QThread) — CPU/RAM polling
src/services/window_monitor.py   # ActiveWindowMonitor(QThread) — foreground window tracking
src/services/macro_recorder.py   # MacroRecorder — pynput keyboard/mouse listener recording, auto-delay insertion, F9=stop/Esc=cancel
src/services/input_detector.py   # InputDetector — launches rundll32+numpad_hook.dll, polls shared memory via QTimer (16ms)
src/native/numpad_hook.c         # C DLL source — WH_KEYBOARD_LL hook + shared memory IPC + rundll32 entry point
src/native/numpad_hook.dll       # Compiled DLL (bundled into exe via PyInstaller --add-binary)
src/native/numpad_hook_console.c # Console debug version of the hook (standalone, not used in production)
src/ui/main_window.py           # MainWindow + TitleBar — frameless resizable window, QSplitter(tree|grid), opacity slider, position persistence, launch_with_foreground, focus_mapped_app (auto-focus target app for hotkey/text/macro), apply_theme, update_media_state/update_mute_state propagation, folder navigation history (_folder_history stack, max 50, navigate_parent() vs navigate_back())
src/ui/button_widget.py         # DeckButton(QPushButton) — themed buttons, custom paintEvent (icon behind text, default icon fallback), _load_pixmap() SVG renderer, marquee scroll for overflow text, context menu (edit/clear/copy/paste), drag-and-drop swap, per-state media toggle updates (_MEDIA_TOGGLE_KEYS), _on_clicked() three-way dispatch (_FOREGROUND_ACTIONS/_TARGET_FOCUS_ACTIONS/default)
src/ui/default_icons.py         # Action type → default icon path resolver (ACTION_ICON_MAP + plugin fallback via _plugin_icon_resolver)
src/ui/toast.py                 # ToastManager + _ToastWidget — themed toast notifications (slide-up, fade, progress bar, stacking)
src/ui/app_finder_dialog.py     # AppFinderDialog — find apps via running processes (psutil) or Start Menu (.lnk), shows exe icons, saves selected icon as PNG + _crop_transparent_padding() for icon cleanup
src/ui/folder_tree.py           # FolderTreeWidget(QTreeWidget) — left panel folder tree with drag-and-drop + per-folder export/import + Move Up/Down reordering via context menu
src/ui/folder_editor_dialog.py  # FolderEditorDialog — name + mapped apps list for folders + "Find App..." button (reuses AppFinderDialog)
src/ui/macro_recording_dialog.py # MacroRecordingDialog — floating overlay during macro recording (event count, elapsed time, Stop/Cancel)
src/ui/button_editor_dialog.py  # ButtonEditorDialog — per-action-type stacked editor + plugin editors + HotkeyRecorderWidget + macro Record button + 8 step type editors + Find App/Browse with auto-icon for launch_app + open_folder Browse
src/ui/settings_dialog.py       # SettingsDialog — grid/behavior/appearance settings + input mode selector + theme selector
src/ui/styles.py                # ThemePalette + ThemeStylesheets + 10 built-in themes + get_theme() resolver
src/ui/tray_icon.py             # TrayIcon(QSystemTrayIcon) — system tray with context menu (show/settings/reset position/quit)
assets/icons/actions/            # Default action icons: {type}.png|.svg per action (includes navigate_parent.svg, navigate_back.svg, open_folder.svg), media_control/{command}.svg for media sub-commands
config/default_config.json       # Default grid (4 rows): Root(media+monitor) → Apps(system utils) → Shortcuts(hotkeys) — all folders have Back button at (3,0) (v2 format)
config/examples/media.json       # Example folder: Media (emoji media controls, mute/play toggle labels, audio device switch, now playing, mic mute)
config/examples/folders.json     # Example folder: 폴더 (open_folder for Pictures/Documents/Downloads/Desktop via %USERPROFILE%)
config/examples/virtual_desktop.json # Example folder: 가상 데스크톱 (Windows virtual desktop hotkeys: switch/create/close/task view)
python/                          # (gitignored, generated) Embedded Python 3.13.2 + pip + site-packages — created by SoftDeck.bat on first run
USAGE.md                         # User manual — reference (Korean)
GUIDE.md                         # User manual — beginner-friendly guide (Korean)
docs/build_pdf.py                # Script to regenerate the PDF guide
```
